<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper >
<mapper namespace="com.mcnc.bizmob.web.domain.board.event.mapper.EventBoardMapper">
    
    <!-- 시퀀스 값을 가져오는 쿼리 -->
    <select id="selectNextEventHeadDocId" resultType="String">
        SELECT 'EVHD' || LPAD(HP_EVENT_BOARD_HEAD_SEQ.NEXTVAL, 8, '0') 
        FROM DUAL
    </select>
    
        <!-- 시퀀스 값을 가져오는 쿼리 -->
    <select id="selectNextEventBodyDocId" resultType="String">
        SELECT 'EVBD' || LPAD(HP_EVENT_BOARD_BODY_SEQ.NEXTVAL, 8, '0') 
        FROM DUAL
    </select>
    
	<select id="selectEventBoardList" parameterType="EventBoardSearchDto" resultType="EventBoardDto">
	    SELECT  *
	    FROM (
	        SELECT DISTINCT a.*, ROWNUM rnum
	        FROM (
	            SELECT 
	                hhm.EVHD_DOC_ID            AS headDocId,
	                hhm.TITLE                  AS title,
	                cdv.parent_cate_id         AS parentCategoryId,
	                cdv.parent_cate_name       AS parentCategoryName,
	                cdv.sub_cate_id            AS subCategoryId,
	                cdv.sub_cate_name          AS subCategoryName,
	                hhm.DISPLAY_FLAG           AS displayFlag,
	                hhm.ATTACH_FLAG            AS attachFlag,
	                hhm.CREATE_DATE            AS createDate,
	                hhm.CREATE_BY              AS createBy,
	                hhm.UPDATE_DATE            AS updateDate,
	                hhm.UPDATE_BY              AS updateBy,
	                hhm.PIN_FLAG               AS pinFlag,
	                hhm.PUB_ALWAYS_FLAG        AS pubAlwaysFlag,
	                hhm.PUB_START_DATE         AS pubStartDate,
	                hhm.PUB_END_DATE           AS pubEndDate,
	                af.FILE_PATH               AS filePath,
	                af.FILE_NAME               AS fileName,
	                af.ATTACH_ID               AS attachId
	            FROM 
	                HP_EVENT_BOARD_HEAD hhm
				LEFT JOIN CATEGORY_DEPTH_VIEW cdv
				  ON hhm.HP_COMMON_CODE_ID = cdv.SUB_CATE_ID
				  OR (
				    cdv.SUB_CATE_ID IS NULL
				    AND hhm.HP_COMMON_CODE_ID = cdv.PARENT_CATE_ID
				    AND NOT EXISTS (
				        SELECT 1 FROM CATEGORY_DEPTH_VIEW sub_check
				        WHERE sub_check.SUB_CATE_ID = hhm.HP_COMMON_CODE_ID
				    )
				  )
	            LEFT JOIN HP_EVENT_BOARD_BODY hhb  
	                ON hhm.EVHD_DOC_ID = hhb.EVHD_DOC_ID
	            LEFT JOIN HP_ATTACH_FILE af  
	                ON hhm.EVHD_DOC_ID = af.DOC_ID  
	                AND af.DELETE_FLAG = 'N'
	            WHERE
	                hhm.DELETE_FLAG = 'N'
				<if test="categoryIds != null and categoryIds.size() > 0">
					  AND (
					    cdv.SUB_CATE_ID IN 
					    <foreach item="categoryId" collection="categoryIds" open="(" separator="," close=")">
					      #{categoryId}
					    </foreach>
					    OR cdv.PARENT_CATE_ID IN 
					    <foreach item="categoryId" collection="categoryIds" open="(" separator="," close=")">
					      #{categoryId}
					    </foreach>
					  )
				</if>
	            <if test="periodSearch != null">
	                <if test="periodSearch.periodType.name() == 'CRE'">
	                    AND hhm.CREATE_DATE BETWEEN #{periodSearch.periodStartDate} AND #{periodSearch.periodEndDate}
	                </if>
	            </if>
	            <if test="keywordSearch != null">
	                <if test="keywordSearch.keywordType.name() == 'TITLE'">
	                    AND hhm.TITLE LIKE '%' || #{keywordSearch.keyword} || '%'
	                </if>
	                <if test="keywordSearch.keywordType.name() == 'CONTENTS'">
	                    AND EXISTS (
	                        SELECT 1 FROM HP_EVENT_BOARD_BODY hhb_sub
	                        WHERE hhb_sub.EVHD_DOC_ID = hhm.EVHD_DOC_ID
	                        AND hhb_sub.CONTENTS LIKE '%' || #{keywordSearch.keyword} || '%'
	                    ) 
	                </if>
	            </if>
	            <if test="displayFlag != null">
	                AND hhm.DISPLAY_FLAG = #{displayFlag}
	            </if>
		            GROUP BY 
	                hhm.EVHD_DOC_ID, hhm.TITLE, cdv.parent_cate_id, cdv.parent_cate_name, 
	                cdv.sub_cate_id, cdv.sub_cate_name, hhm.DISPLAY_FLAG, hhm.ATTACH_FLAG, 
	                hhm.CREATE_DATE, hhm.CREATE_BY, hhm.UPDATE_DATE, hhm.UPDATE_BY, hhm.PIN_FLAG,
	                hhm.PUB_ALWAYS_FLAG, hhm.PUB_START_DATE, hhm.PUB_END_DATE,
	                af.FILE_PATH, af.FILE_NAME, af.ATTACH_ID
	            ORDER BY
	                hhm.EVHD_DOC_ID DESC
	        ) a
	        WHERE ROWNUM <![CDATA[<=]]> #{endRow} 
	    )
	    WHERE rnum <![CDATA[>]]> #{startRow} 
	</select>
    
		<select id="selectEventBoardDocCount" parameterType="EventBoardSearchDto" resultType="int">
		    SELECT COUNT(*)
		    FROM HP_EVENT_BOARD_HEAD hhm
		    LEFT JOIN CATEGORY_DEPTH_VIEW cdv
		        ON hhm.HP_COMMON_CODE_ID = cdv.sub_cate_Id
		    WHERE
		        hhm.DELETE_FLAG = 'N'
		        
		    <if test="categoryIds != null and categoryIds.size() > 0">
		        AND cdv.SUB_CATE_ID IN 
		        <foreach item="categoryId" collection="categoryIds" open="(" separator="," close=")">
		            #{categoryId}
		        </foreach>
		    </if>
		    <if test="keywordSearch != null">
		        <if test="keywordSearch.keywordType.name() == 'TITLE'">
		            AND hhm.TITLE LIKE '%' || #{keywordSearch.keyword} || '%'
		        </if>
		        <if test="keywordSearch.keywordType.name() == 'CONTENTS'">
		            AND EXISTS (
		                SELECT 1 FROM HP_EVENT_BOARD_BODY hhb
		                WHERE hhb.EVHD_DOC_ID = hhm.EVHD_DOC_ID
		                AND hhb.CONTENTS LIKE '%' || #{keywordSearch.keyword} || '%'
		            )  
		        </if>
		    </if>
		    <if test="displayFlag != null">
		        AND hhm.DISPLAY_FLAG = #{displayFlag}
		    </if>
		</select>


    <select id="selectEventBoardHeadDetail" resultType="EventBoardHeadDto" parameterType="String">
    	SELECT 
			hhm.EVHD_DOC_ID 			AS headDocId
			, hhm.TITLE 				AS title
			, cdv.PARENT_CATE_ID 		AS parentCategoryId
			, cdv.PARENT_CATE_NAME 		AS parentCategoryName
			, cdv.SUB_CATE_ID 			AS subCategoryId
			, cdv.SUB_CATE_NAME 		AS subCategoryName
			, hhm.DISPLAY_FLAG 			AS displayFlag 
			, hhm.PUB_ALWAYS_FLAG 		AS pubAlwaysFlag
			, hhm.PUB_START_DATE 		AS pubStartDate
			, hhm.PUB_END_DATE 			AS pubEndDate
			, hhm.CREATE_DATE 			AS createDate
			, hhm.CREATE_BY 			AS createBy
			, hhm.PIN_FLAG 				AS pinFlag
			, hhm.ATTACH_FLAG 			AS attachFlag
		FROM
			HP_EVENT_BOARD_HEAD hhm 
		LEFT JOIN CATEGORY_DEPTH_VIEW cdv
				  ON hhm.HP_COMMON_CODE_ID = cdv.SUB_CATE_ID
				  OR (
				    cdv.SUB_CATE_ID IS NULL
				    AND hhm.HP_COMMON_CODE_ID = cdv.PARENT_CATE_ID
				    AND NOT EXISTS (
				        SELECT 1 FROM CATEGORY_DEPTH_VIEW sub_check
				        WHERE sub_check.SUB_CATE_ID = hhm.HP_COMMON_CODE_ID
				    )
				  )
		WHERE 
			hhm.DELETE_FLAG = 'N'
			AND hhm.EVHD_DOC_ID = #{headDocId}
    </select>
    
        <select id="selectEventBoardBodyDetail" resultType="EventBoardBodyDto" parameterType="String">
    	SELECT 
			hhb.EVHD_DOC_ID 			AS headDocId
			, hhb.EVBD_DOC_ID 			AS bodyDocId
			, hhb.CONTENTS				AS contents
			, hhb.CAUTION_MATTER 		AS cautionMatter 
			, hhb.BTN_NAME 				AS btnName 	
			, hhb.BTN_LINK_TYPE			AS btnLinkType 	
			, hhb.BUTTON_LINK_LOCATION	AS btnLinkLocation 	
			, hhb.CREATE_DATE 			AS createDate
			, hhb.CREATE_BY 			AS createBy
		FROM
			HP_EVENT_BOARD_BODY hhb 
		WHERE 
			hhb.EVHD_DOC_ID = #{headDocId}
    </select>
    
    
	<insert id="insertEventBoardHead" parameterType="EventBoardHeadDto">
	    INSERT INTO HP_EVENT_BOARD_HEAD (
	          EVHD_DOC_ID
	        , TITLE
	        , DISPLAY_FLAG
	        , CREATE_DATE
	        , CREATE_BY
	        , HP_COMMON_CODE_ID
	        , PIN_FLAG
	        , PUB_ALWAYS_FLAG
    		, PUB_START_DATE
    		, PUB_END_DATE
	        , DELETE_FLAG
	        , ATTACH_FLAG
	    ) VALUES (
	          #{headDocId}
	        , #{title}
	        , #{displayFlag}
	        , SYSDATE
	        , #{createBy}
        ,<choose>
            <when test="subCategoryId != null">
                 #{subCategoryId}
            </when>
            <when test="parentCategoryId != null">
                #{parentCategoryId}
            </when>
            <otherwise>
                NULL
            </otherwise>
        </choose>
	        , #{pinFlag}
	        , #{pubAlwaysFlag}
    		, #{pubStartDate}
			, #{pubEndDate, jdbcType=DATE}
	        , 'N'
	        , #{attachFlag}
	    )
	</insert>

	<insert id="insertEventBoardBody" parameterType="EventBoardBodyDto">
	    INSERT INTO HP_EVENT_BOARD_BODY (
	          EVBD_DOC_ID
	        , EVHD_DOC_ID
	        , CONTENTS
	        , CAUTION_MATTER
	        , BTN_NAME
	        , BTN_LINK_TYPE
	        , BUTTON_LINK_LOCATION
	        , CREATE_DATE
	        , CREATE_BY
	    ) VALUES
	    	       (
	        #{bodyDocId}
	        , #{headDocId}
	        , #{contents, jdbcType=VARCHAR}
	        , #{cautionMatter, jdbcType=VARCHAR}
	        , #{btnName, jdbcType=VARCHAR}
	        , #{btnLinkType, jdbcType=VARCHAR}
	        , #{btnLinkLocation, jdbcType=VARCHAR}
	        , SYSDATE
	        , #{createBy}
	    )	    
	</insert>
	
	<update id="updateEventBoardHead" parameterType="EventBoardHeadDto">
        UPDATE 
        	HP_EVENT_BOARD_HEAD
        SET
            TITLE = #{title}
            , DISPLAY_FLAG = #{displayFlag}
            ,PIN_FLAG = #{pinFlag}
            , PUB_ALWAYS_FLAG = #{pubAlwaysFlag}
  			, PUB_START_DATE = #{pubStartDate}
  			<if test="pubEndDate != null">
  				, PUB_END_DATE = #{pubEndDate}
  			</if>
            ,ATTACH_FLAG = #{attachFlag}
        <choose>
            <when test="subCategoryId != null">
                , HP_COMMON_CODE_ID = #{subCategoryId}
            </when>
            <when test="parentCategoryId != null">
                , HP_COMMON_CODE_ID = #{parentCategoryId}
            </when>
        </choose>            
        	,UPDATE_DATE = SYSDATE
            ,UPDATE_BY = #{updateBy}
        WHERE 
        	EVHD_DOC_ID = #{headDocId}

	</update>

	<update id="updateEventBoardBody" parameterType="EventBoardBodyDto">
	        UPDATE 
	        	HP_EVENT_BOARD_BODY
	        SET
	             CONTENTS = #{contents, jdbcType=VARCHAR}
	            , CAUTION_MATTER = #{cautionMatter, jdbcType=VARCHAR}
	            , BTN_NAME = #{btnName, jdbcType=VARCHAR}
	            , BTN_LINK_TYPE = #{btnLinkType, jdbcType=VARCHAR}
	            , BUTTON_LINK_LOCATION = #{btnLinkLocation, jdbcType=VARCHAR}
	            , UPDATE_DATE = SYSDATE
	            , UPDATE_BY = #{updateBy}
	        WHERE 
	        EVBD_DOC_ID = #{bodyDocId} 
	        AND EVHD_DOC_ID = #{headDocId}
	</update>

    <update id="deleteEventBoard" parameterType="String">
    	UPDATE 
    		HP_EVENT_BOARD_HEAD
  		SET
  			DELETE_FLAG = 'Y'
    		, UPDATE_DATE = SYSDATE
    	WHERE
        	EVHD_DOC_ID = #{headDocId}
    </update>
    
    <update id="updateEventBoardDisplayFlag" parameterType="EventBoardHeadDto">
    	UPDATE
    		HP_EVENT_BOARD_HEAD
  		SET
  			DISPLAY_FLAG = #{displayFlag}	
  			, UPDATE_BY = #{updateBy}
    		, UPDATE_DATE = SYSDATE
    	WHERE
        	EVHD_DOC_ID = #{headDocId}
    </update>
    
    <select id="getAppliedEventIds" resultType="string">
    	SELECT 
    		EVENT_ID 
    	FROM 
    		APP_EVENTJOIN_INFO
	</select>
	
	
</mapper>
