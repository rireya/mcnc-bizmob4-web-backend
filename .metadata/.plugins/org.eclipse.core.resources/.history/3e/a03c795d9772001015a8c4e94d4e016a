<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mcnc.bizmob.web.domain.board.hipassinfo.mapper.HipassInfoMapper">
    
    <!-- 시퀀스 값을 가져오는 쿼리 -->
    <select id="selectNextInfoMetaDocId" resultType="String">
        SELECT 'META' || LPAD(HP_HIPASS_META_SEQ.NEXTVAL, 8, '0') 
        FROM DUAL
    </select>
    
        <!-- 시퀀스 값을 가져오는 쿼리 -->
    <select id="selectNextInfoBodyDocId" resultType="String">
        SELECT 'BODY' || LPAD(HP_HIPASS_BODY_SEQ.NEXTVAL, 8, '0') 
        FROM DUAL
    </select>
    
	<select id="selectHipassInfoList" parameterType="HipassInfoSerachDto" resultType="HipassInfoDto">
	    SELECT  *
	    FROM (
	        SELECT DISTINCT a.*, ROWNUM rnum
	        FROM (
	            SELECT 
	                hhm.META_DOC_ID            AS metaDocId
	                , hhm.TITLE                AS title
	                , cdv.parent_cate_id       AS parentCategoryId
	                , cdv.parent_cate_name     AS parentCategoryName
	                , cdv.sub_cate_id          AS subCategoryId
	                , cdv.sub_cate_name        AS subCategoryName
	                , hhm.DISPLAY_FLAG         AS displayFlag
	                , hhm.ATTACH_FLAG          AS attachFlag
	                , hhm.CREATE_DATE          AS createDate
	                , hhm.CREATE_BY            AS createBy
	                , hhm.UPDATE_DATE          AS updateDate
	                , hhm.UPDATE_BY            AS updateBy
	                , hhm.PIN_FLAG			   AS pinFlag
	            FROM 
	                HP_HIPASS_META hhm
				LEFT JOIN CATEGORY_DEPTH_VIEW cdv
				  ON hhm.HP_COMMON_CODE_ID = cdv.SUB_CATE_ID
				  OR (
				    cdv.SUB_CATE_ID IS NULL
				    AND hhm.HP_COMMON_CODE_ID = cdv.PARENT_CATE_ID
				    AND NOT EXISTS (
				        SELECT 1 FROM CATEGORY_DEPTH_VIEW sub_check
				        WHERE sub_check.SUB_CATE_ID = hhm.HP_COMMON_CODE_ID
				    )
				  )
	            LEFT JOIN HP_HIPASS_BODY hhb  
	                ON hhm.META_DOC_ID = hhb.META_DOC_ID
	            WHERE
	                hhm.DELETE_FLAG = 'N'
					<if test="categoryIds != null and categoryIds.size() > 0">
					  AND (
					    cdv.SUB_CATE_ID IN 
					    <foreach item="categoryId" collection="categoryIds" open="(" separator="," close=")">
					      #{categoryId}
					    </foreach>
					    OR cdv.PARENT_CATE_ID IN 
					    <foreach item="categoryId" collection="categoryIds" open="(" separator="," close=")">
					      #{categoryId}
					    </foreach>
					  )
					</if>
	                <if test="periodSearch != null">
						<if test="periodSearch.periodType.name() == 'CRE'">
							AND hhm.CREATE_DATE BETWEEN #{periodSearch.periodStartDate} AND #{periodSearch.periodEndDate}
						</if>
					</if>
	                <if test="keywordSearch != null">
	                    <if test="keywordSearch.keywordType.name() == 'TITLE'">
	                        AND hhm.TITLE LIKE '%' || #{keywordSearch.keyword} || '%'
	                    </if>
	                    <if test="keywordSearch.keywordType.name() == 'CONTENTS'">
	                        AND EXISTS (
	                            SELECT 1 FROM HP_HIPASS_BODY hhb_sub
	                            WHERE hhb_sub.META_DOC_ID = hhm.META_DOC_ID
	                            AND hhb_sub.CONTENTS LIKE '%' || #{keywordSearch.keyword} || '%'
	                        ) 
	                    </if>
	                </if>
	                <if test="displayFlag != null">
	                    AND hhm.DISPLAY_FLAG = #{displayFlag}
	                </if>
	            GROUP BY 
	                hhm.META_DOC_ID, hhm.TITLE, cdv.parent_cate_id, cdv.parent_cate_name, 
	                cdv.sub_cate_id, cdv.sub_cate_name, hhm.DISPLAY_FLAG, hhm.ATTACH_FLAG, 
	                hhm.CREATE_DATE, hhm.CREATE_BY, hhm.UPDATE_DATE, hhm.UPDATE_BY, hhm.PIN_FLAG
	            ORDER BY
	                hhm.META_DOC_ID DESC
	        ) a
	        WHERE ROWNUM <![CDATA[<=]]> #{endRow} 
	    )
	    WHERE rnum <![CDATA[>]]> #{startRow} 
	</select>
    
	<select id="selectHipassInfoDocCount" parameterType="HipassInfoSerachDto" resultType="int">
	    SELECT COUNT(*)
	    FROM HP_HIPASS_META hhm
	    LEFT JOIN CATEGORY_DEPTH_VIEW cdv
	        ON hhm.HP_COMMON_CODE_ID = cdv.sub_cate_Id
	    WHERE
	        hhm.DELETE_FLAG = 'N'
	        <if test="categoryIds != null and categoryIds.size() > 0">
	            AND cdv.SUB_CATE_ID IN 
	            <foreach item="categoryId" collection="categoryIds" open="(" separator="," close=")">
	                #{categoryId}
	            </foreach>
	        </if>
	        <if test="keywordSearch != null">
	            <if test="keywordSearch.keywordType.name() == 'TITLE'">
	                AND hhm.TITLE LIKE '%' || #{keywordSearch.keyword} || '%'
	            </if>
	            <if test="keywordSearch.keywordType.name() == 'CONTENTS'">
	                AND EXISTS (
	                    SELECT 1 FROM HP_HIPASS_BODY hhb
	                    WHERE hhb.META_DOC_ID = hhm.META_DOC_ID
	                    AND hhb.CONTENTS LIKE '%' || #{keywordSearch.keyword} || '%'
	                )  
	            </if>
	        </if>
	        <if test="displayFlag != null">
	            AND hhm.DISPLAY_FLAG = #{displayFlag}
	        </if>
	</select>


	 <select id="selectHipassInfoMetaDetail" resultType="HipassInfoMetaDto" parameterType="String">
		SELECT 
		    hhm.META_DOC_ID            AS metaDocId,
		    hhm.TITLE                  AS title,
		    cdv.PARENT_CATE_ID         AS parentCategoryId,
		    cdv.PARENT_CATE_NAME       AS parentCategoryName,
		    cdv.SUB_CATE_ID            AS subCategoryId,
		    cdv.SUB_CATE_NAME          AS subCategoryName,
		    hhm.DISPLAY_FLAG           AS displayFlag,
		    hhm.CREATE_DATE            AS createDate,
		    hhm.CREATE_BY              AS createBy,
		    hhm.PIN_FLAG               AS pinFlag,
		    hhm.ATTACH_FLAG            AS attachFlag
		FROM HP_HIPASS_META hhm
			LEFT JOIN CATEGORY_DEPTH_VIEW cdv
			  ON hhm.HP_COMMON_CODE_ID = cdv.SUB_CATE_ID
			  OR (
			    cdv.SUB_CATE_ID IS NULL
			    AND hhm.HP_COMMON_CODE_ID = cdv.PARENT_CATE_ID
			    AND NOT EXISTS (
			        SELECT 1 FROM CATEGORY_DEPTH_VIEW sub_check
			        WHERE sub_check.SUB_CATE_ID = hhm.HP_COMMON_CODE_ID
			    )
			  )
		WHERE 
		    hhm.DELETE_FLAG = 'N'
		    AND hhm.META_DOC_ID = #{hipassInfoDocId}
    </select>
    
        <select id="selectHipassInfoBodyDetail" resultType="HipassInfoBodyDto" parameterType="String">
    	SELECT 
			hhb.META_DOC_ID 			AS metaDocId
			, hhb.BODY_DOC_ID 			AS bodyDocId
			, hhb.CONTENTS				AS contents
			, hhb.ORDER_NO 				AS orderNo 
			, hhb.LINK_LABEL 			AS linkLabel 
			, hhb.LINK_URL 				AS linkUrl 	
			, hhb.CREATE_DATE 			AS createDate
			, hhb.CREATE_BY 			AS createBy
			, hhb.LINK_TYPE				AS linkType
		FROM
			HP_HIPASS_BODY hhb 
		WHERE 
			hhb.META_DOC_ID = #{hipassInfoDocId}
			AND hhb.DELETE_FLAG = 'N'  
			
    </select>
    
    
	<insert id="insertHipassInfoMeta" parameterType="HipassInfoMetaDto">
	    INSERT INTO HP_HIPASS_META (
	          META_DOC_ID
	        , TITLE
	        , DISPLAY_FLAG
	        , CREATE_DATE
	        , CREATE_BY
	        , HP_COMMON_CODE_ID
	        , PIN_FLAG
	        , DELETE_FLAG
	        , ATTACH_FLAG
	    ) VALUES (
	          #{metaDocId}
	        , #{title}
	        , #{displayFlag}
	        , SYSDATE
	        , #{createBy}
        ,<choose>
            <when test="subCategoryId != null">
                #{subCategoryId}
            </when>
            <when test="parentCategoryId != null">
                #{parentCategoryId}
            </when>
            <otherwise>
                NULL
            </otherwise>
        </choose>
	        , #{pinFlag}
	        , 'N'
	        , #{attachFlag}
	    )
	</insert>

	<insert id="insertHipassInfoBody" parameterType="HipassInfoBodyDto">
	    INSERT INTO HP_HIPASS_BODY (
	          BODY_DOC_ID
	        , META_DOC_ID
	        , ORDER_NO
	        , CONTENTS
	        , LINK_LABEL
	        , LINK_TYPE
	        , LINK_URL
	        , DELETE_FLAG
	        , CREATE_DATE
	        , CREATE_BY
	    ) VALUES
	    	       (
	        #{bodyDocId}
	        , #{metaDocId}
	        , #{orderNo}
	        , #{contents, jdbcType=VARCHAR}
	        , #{linkLabel, jdbcType=VARCHAR}
	        , #{linkType, jdbcType=VARCHAR}
	        , #{linkUrl, jdbcType=VARCHAR}
	        , 'N'
	        , SYSDATE
	        , #{createBy}
	    )	    
	</insert>
	
	<update id="updateHipassInfoMeta" parameterType="HipassInfoMetaDto">
        UPDATE 
        	HP_HIPASS_META
        SET
            TITLE = #{title}
            , DISPLAY_FLAG = #{displayFlag}
            ,PIN_FLAG = #{pinFlag}
            ,ATTACH_FLAG = #{attachFlag}
        <choose>
            <when test="subCategoryId != null">
                , HP_COMMON_CODE_ID = #{subCategoryId}
            </when>
            <when test="parentCategoryId != null">
                , HP_COMMON_CODE_ID = #{parentCategoryId}
            </when>
        </choose>
            ,UPDATE_DATE = SYSDATE
            ,UPDATE_BY = #{updateBy}
        WHERE 
        	META_DOC_ID = #{metaDocId}

	</update>

	<update id="updateHipassInfoBody" parameterType="HipassInfoBodyDto">
	        UPDATE 
	        	HP_HIPASS_BODY
	        SET
	             ORDER_NO = #{orderNo}
	            , CONTENTS = #{contents, jdbcType=VARCHAR}
	            , LINK_TYPE = #{linkType, jdbcType=VARCHAR}
	            , LINK_LABEL = #{linkLabel, jdbcType=VARCHAR}
	            , LINK_URL = #{linkUrl, jdbcType=VARCHAR}
	            , UPDATE_DATE = SYSDATE
	            , UPDATE_BY = #{updateBy}
	        WHERE 
	        BODY_DOC_ID = #{bodyDocId} 
	        AND META_DOC_ID = #{metaDocId}
	</update>

    <update id="deleteHipassInfo" parameterType="String">
    	UPDATE 
    		HP_HIPASS_META
  		SET
  			DELETE_FLAG = 'Y'
    		, UPDATE_DATE = SYSDATE
    	WHERE
        	META_DOC_ID = #{metaDocId}
    </update>
    
    <update id="updateHipassInfoDisplayFlag" parameterType="HipassInfoMetaDto">
    	UPDATE
    		HP_HIPASS_META
  		SET
  			DISPLAY_FLAG = #{displayFlag}	
  			, UPDATE_BY = #{updateBy}
    		, UPDATE_DATE = SYSDATE
    	WHERE
        	META_DOC_ID = #{metaDocId}
    </update>
    
	<update id="deleteHipassInfoBody" parameterType="String">
	    UPDATE 
	        HP_HIPASS_BODY
	    SET
	        DELETE_FLAG = 'Y'
	        , UPDATE_DATE = SYSDATE
	        , UPDATE_BY = #{updateBy}
	    WHERE 
	        BODY_DOC_ID = #{bodyDocId}
	</update>
	
	
</mapper>
