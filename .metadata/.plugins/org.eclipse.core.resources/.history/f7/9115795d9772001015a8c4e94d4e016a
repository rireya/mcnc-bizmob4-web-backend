<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mcnc.bizmob.web.domain.board.faq.mapper.FaqMapper">
    
    <!-- 시퀀스 값을 가져오는 쿼리 -->
    <select id="selectNextFaqDocId" resultType="String">
        SELECT 'FAQB' || LPAD(HP_FAQ_BOARD_SEQ.NEXTVAL, 8, '0') 
        FROM DUAL
    </select>
    
    <select id="selectFaqBoardDocList" parameterType="FaqBoardSerachDto" resultType="FaqBoardDto">
		SELECT *
		FROM (
		    SELECT a.*, ROWNUM rnum
		    FROM (
				SELECT 
					hfb.FAQ_DOC_ID			AS faqDocId
					, hfb.TITLE				AS title
					, hfb.CONTENTS			AS contents
					, cdv.parent_cate_id 	AS parentCategoryId
					, cdv.parent_cate_name 	AS parentCategoryName
					, cdv.sub_cate_id 		AS subCategoryId
					, cdv.sub_cate_name 	AS subCategoryName
					, hfb.DISPLAY_FLAG		AS displayFlag
					, hfb.ATTACH_FLAG		AS attachFlag
					, hfb.CREATE_DATE		AS createDate
					, hfb.CREATE_BY			AS createBy
					, hfb.UPDATE_DATE		AS updateDate
					, hfb.UPDATE_BY			AS updateBy
				FROM 
					HP_FAQ_BOARD hfb
				LEFT JOIN CATEGORY_DEPTH_VIEW cdv
				  ON hfb.HP_COMMON_CODE_ID = cdv.SUB_CATE_ID
				  OR (
				    cdv.SUB_CATE_ID IS NULL
				    AND hfb.HP_COMMON_CODE_ID = cdv.PARENT_CATE_ID
				    AND NOT EXISTS (
				        SELECT 1 FROM CATEGORY_DEPTH_VIEW sub_check
				        WHERE sub_check.SUB_CATE_ID = hfb.HP_COMMON_CODE_ID
				    )
				  )
				WHERE
					DELETE_FLAG = 'N'
					<if test="categoryIds != null and categoryIds.size() > 0">
					  AND (
					    cdv.SUB_CATE_ID IN 
					    <foreach item="categoryId" collection="categoryIds" open="(" separator="," close=")">
					      #{categoryId}
					    </foreach>
					    OR cdv.PARENT_CATE_ID IN 
					    <foreach item="categoryId" collection="categoryIds" open="(" separator="," close=")">
					      #{categoryId}
					    </foreach>
					  )
					</if>
					<if test="keywordSearch != null">
						<if test="keywordSearch.keywordType.name() == 'TITLE'">
							AND hfb.TITLE LIKE '%' || #{keywordSearch.keyword} || '%'
						</if>
						<if test="keywordSearch.keywordType.name() == 'CONTENTS'">
							AND hfb.CONTENTS LIKE '%' || #{keywordSearch.keyword} || '%'	
						</if>
					</if>
					<if test="displayFlag != null">
						AND hfb.DISPLAY_FLAG = #{displayFlag}
					</if>
				ORDER BY
					hfb.FAQ_DOC_ID DESC
		    ) a
		    WHERE ROWNUM <![CDATA[<=]]> #{endRow} -- 원하는 마지막 행 번호
		)
		WHERE rnum <![CDATA[>]]> #{startRow} -- 원하는 시작 행 번호
    </select>
    
    <select id="selectFaqBoardDocCount" parameterType="FaqBoardSerachDto" resultType="int">
		SELECT 
			COUNT(*)
		FROM 
			HP_FAQ_BOARD hfb
			LEFT JOIN CATEGORY_DEPTH_VIEW cdv
				ON hfb.HP_COMMON_CODE_ID = cdv.sub_cate_Id
		WHERE
			DELETE_FLAG = 'N'
			<if test="categoryIds != null and categoryIds.size() > 0">
				AND cdv.SUB_CATE_ID IN 
				<foreach item="categoryId" collection="categoryIds" open="(" separator="," close=")">
					#{categoryId}
		        </foreach>
			</if>
			<if test="keywordSearch != null">
				<if test="keywordSearch.keywordType.name() == 'TITLE'">
					AND hfb.TITLE LIKE '%' || #{keywordSearch.keyword} || '%'
				</if>
				<if test="keywordSearch.keywordType.name() == 'CONTENTS'">
					AND hfb.CONTENTS LIKE '%' || #{keywordSearch.keyword} || '%'	
				</if>
			</if>
			<if test="displayFlag != null">
				AND hfb.DISPLAY_FLAG = #{displayFlag}
			</if>
		ORDER BY
			hfb.FAQ_DOC_ID DESC
    </select>
    
    <select id="selectFaqDocDetail" resultType="FaqBoardDto" parameterType="String">
    	SELECT 
			hfb.FAQ_DOC_ID 				AS faqDocId
			, hfb.TITLE 				AS title
			, hfb.CONTENTS				AS contents
			, cdv.PARENT_CATE_ID 		AS parentCategoryId
			, cdv.PARENT_CATE_NAME 		AS parentCategoryName
			, cdv.SUB_CATE_ID 			AS subCategoryId
			, cdv.SUB_CATE_NAME 		AS subCategoryName
			, hfb.DISPLAY_FLAG 			AS displayFlag 
			, hfb.CREATE_DATE 			AS createDate
			, hfb.CREATE_BY 			AS createBy
			, hfb.LINK_TYPE_1  			AS linkType1
			, hfb.LINK_TYPE_2  			AS linkType2
			, hfb.LINK_TYPE_3 			AS linkType3
			, hfb.LINK_VALUE_1			AS linkValue1
			, hfb.LINK_VALUE_2			AS linkValue2
			, hfb.LINK_VALUE_3 			AS linkValue3
			, hfb.DELETE_FLAG 
		FROM
			HP_FAQ_BOARD hfb 
		LEFT JOIN CATEGORY_DEPTH_VIEW cdv
				  ON hfb.HP_COMMON_CODE_ID = cdv.SUB_CATE_ID
				  OR (
				    cdv.SUB_CATE_ID IS NULL
				    AND hfb.HP_COMMON_CODE_ID = cdv.PARENT_CATE_ID
				    AND NOT EXISTS (
				        SELECT 1 FROM CATEGORY_DEPTH_VIEW sub_check
				        WHERE sub_check.SUB_CATE_ID = hfb.HP_COMMON_CODE_ID
				    )
				  )
		WHERE 
			hfb.DELETE_FLAG = 'N'
			AND hfb.FAQ_DOC_ID = #{faqDocId}
    </select>
    
    
     <insert id="insertFaqDoc" parameterType="FaqBoardDto">
    	INSERT INTO HPCMOBILE.HP_FAQ_BOARD (
    		FAQ_DOC_ID
    		, TITLE
    		, CONTENTS
    		, HP_COMMON_CODE_ID
    		, DISPLAY_FLAG
    		, ATTACH_FLAG
    		, DELETE_FLAG
			, LINK_TYPE_1  		
			, LINK_TYPE_2  		
			, LINK_TYPE_3 		
			, LINK_VALUE_1		
			, LINK_VALUE_2		
			, LINK_VALUE_3 
    		, CREATE_BY
    		, CREATE_DATE
    	) VALUES ( 
    		#{faqDocId}
    		, #{title}
    		, #{contents}
        ,<choose>
            <when test="subCategoryId != null">
                #{subCategoryId}
            </when>
            <when test="parentCategoryId != null">
                #{parentCategoryId}
            </when>
            <otherwise>
                NULL
            </otherwise>
        </choose>
            , #{displayFlag}
    		, 'N'
    		, 'N'
    		, #{linkType1, jdbcType=VARCHAR}
    		, #{linkType2, jdbcType=VARCHAR}
    		, #{linkType3, jdbcType=VARCHAR}
    		, #{linkValue1, jdbcType=VARCHAR}
    		, #{linkValue2, jdbcType=VARCHAR}
    		, #{linkValue3, jdbcType=VARCHAR}
    		, #{createBy}
    		, SYSDATE
    	)
    </insert>
    
    
    <update id="updateFaqDoc" parameterType="FaqBoardDto">
    	UPDATE 
  			HPCMOBILE.HP_FAQ_BOARD
  		SET
  			TITLE = #{title}
  			, CONTENTS = #{contents}
  			, DISPLAY_FLAG = #{displayFlag}
        <choose>
            <when test="subCategoryId != null">
                , HP_COMMON_CODE_ID = #{subCategoryId}
            </when>
            <when test="parentCategoryId != null">
                , HP_COMMON_CODE_ID = #{parentCategoryId}
            </when>
        </choose>     
			, LINK_TYPE_1 =  #{linkType1, jdbcType=VARCHAR}
			, LINK_TYPE_2 = #{linkType2, jdbcType=VARCHAR}
			, LINK_TYPE_3 =	#{linkType3, jdbcType=VARCHAR}
			, LINK_VALUE_1	= #{linkValue1, jdbcType=VARCHAR}
			, LINK_VALUE_2	= #{linkValue2, jdbcType=VARCHAR}
			, LINK_VALUE_3  = #{linkValue3, jdbcType=VARCHAR}
  			, UPDATE_BY = #{updateBy}
    		, UPDATE_DATE = SYSDATE
    	WHERE
    		FAQ_DOC_ID = #{faqDocId}
    </update>
    
    
    <update id="deleteFaqDoc" parameterType="String">
    	UPDATE 
  			HPCMOBILE.HP_FAQ_BOARD
  		SET
  			DELETE_FLAG = 'Y'
    		, UPDATE_DATE = SYSDATE
    	WHERE
    		FAQ_DOC_ID = #{faqDocId}
    </update>
    
    
    <update id="updateFaqDocDisplayFlag" parameterType="FaqBoardDto">
    	UPDATE
  			HPCMOBILE.HP_FAQ_BOARD
  		SET
  			DISPLAY_FLAG = #{displayFlag}	
  			, UPDATE_BY = #{updateBy}
    		, UPDATE_DATE = SYSDATE
    	WHERE
    		FAQ_DOC_ID = #{faqDocId}
    </update>
    
    
</mapper>
