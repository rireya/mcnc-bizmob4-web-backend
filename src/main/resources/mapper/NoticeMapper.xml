<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mcnc.bizmob.web.domain.board.notice.mapper.NoticeMapper">
    
    <!-- 시퀀스 값을 가져오는 쿼리 -->
    <select id="selectNextNoticeDocId" resultType="String">
        SELECT 'NOTI_' || LPAD(HP_NOTICE_BOARD_SEQ.NEXTVAL, 8, '0') 
        FROM DUAL
    </select>
    
	<select id="selectNoticeBoardDocList" parameterType="NoticeBoardSearchDto" resultType="NoticeBoardDto">
	    SELECT *
	    FROM (
	        SELECT a.*, ROWNUM rnum
	        FROM (
	            SELECT 
	                nb.NOTICE_DOC_ID            AS noticeDocId,
	                nb.TITLE                    AS title,
	                nb.CONTENTS                 AS contents,
	                cdv.PARENT_CATE_ID          AS parentCategoryId,
	                cdv.PARENT_CATE_NAME        AS parentCategoryName,
	                cdv.SUB_CATE_ID             AS subCategoryId,
	                cdv.SUB_CATE_NAME           AS subCategoryName,
	                nb.DISPLAY_FLAG             AS displayFlag,
	                nb.ATTACH_FLAG              AS attachFlag,
	                nb.PIN_FLAG                 AS pinFlag,
	                nb.PUB_ALWAYS_FLAG          AS pubAlwaysFlag,
	                nb.PUB_START_DATE           AS pubStartDate,
	                nb.PUB_END_DATE             AS pubEndDate,
	                nb.CREATE_DATE              AS createDate,
	                nb.CREATE_BY                AS createBy
	            FROM 
	                HP_NOTICE_BOARD nb
				LEFT JOIN CATEGORY_DEPTH_VIEW cdv
				  ON nb.HP_COMMON_CODE_ID = cdv.SUB_CATE_ID
				  OR (
				    cdv.SUB_CATE_ID IS NULL
				    AND nb.HP_COMMON_CODE_ID = cdv.PARENT_CATE_ID
				    AND NOT EXISTS (
				        SELECT 1 FROM CATEGORY_DEPTH_VIEW sub_check
				        WHERE sub_check.SUB_CATE_ID = nb.HP_COMMON_CODE_ID
				    )
				  )
	            WHERE
	                nb.DELETE_FLAG = 'N'
	                <if test="categoryIds != null and categoryIds.size() > 0">
	                    AND cdv.SUB_CATE_ID IN 
	                    <foreach item="categoryId" collection="categoryIds" open="(" separator="," close=")">
	                        #{categoryId}
	                    </foreach>
	                </if>
	                <if test="periodSearch != null">
	                    <if test="periodSearch.periodType.name() == 'PUB'">
	                        AND nb.PUB_START_DATE BETWEEN #{periodSearch.periodStartDate} AND #{periodSearch.periodEndDate}
	                    </if>
	                    <if test="periodSearch.periodType.name() == 'CRE'">
	                        AND nb.CREATE_DATE BETWEEN #{periodSearch.periodStartDate} AND #{periodSearch.periodEndDate}
	                    </if>
	                </if>
	                <if test="keywordSearch != null">
	                    <if test="keywordSearch.keywordType.name() == 'TITLE'">
	                        AND nb.TITLE LIKE '%' || #{keywordSearch.keyword} || '%'
	                    </if>
	                    <if test="keywordSearch.keywordType.name() == 'CONTENTS'">
	                        AND nb.CONTENTS LIKE '%' || #{keywordSearch.keyword} || '%'
	                    </if>
	                </if>
	                <if test="displayFlag != null">
	                    AND nb.DISPLAY_FLAG = #{displayFlag}
	                </if>
			        <if test="requestSource == 'APP'">
						AND (
							 nb.PUB_END_DATE IS NULL 
							 OR nb.PUB_ALWAYS_FLAG = 'Y' 
							 OR nb.PUB_END_DATE >= SYSDATE
						)
			        </if>
	            ORDER BY
	                nb.PIN_FLAG DESC, 
	                nb.NOTICE_DOC_ID DESC
	        ) a
	        WHERE ROWNUM <![CDATA[<=]]> #{endRow} -- 원하는 마지막 행 번호
	    )
	    WHERE rnum <![CDATA[>]]> #{startRow} -- 원하는 시작 행 번호
	</select>

    
	<select id="selectNoticeBoardDocCount" parameterType="NoticeBoardSearchDto" resultType="int">
	    SELECT COUNT(*)
	    FROM HP_NOTICE_BOARD nb
	    LEFT JOIN CATEGORY_DEPTH_VIEW cdv
	        ON nb.HP_COMMON_CODE_ID = cdv.SUB_CATE_ID
	    WHERE
	        nb.DELETE_FLAG = 'N'
			<if test="categoryIds != null and categoryIds.size() > 0">
					  AND (
					    cdv.SUB_CATE_ID IN 
					    <foreach item="categoryId" collection="categoryIds" open="(" separator="," close=")">
					      #{categoryId}
					    </foreach>
					    OR cdv.PARENT_CATE_ID IN 
					    <foreach item="categoryId" collection="categoryIds" open="(" separator="," close=")">
					      #{categoryId}
					    </foreach>
					  )
			</if>
	        <if test="periodSearch != null">
	            <if test="periodSearch.periodType.name() == 'PUB'">
	                AND nb.PUB_START_DATE BETWEEN #{periodSearch.periodStartDate} AND #{periodSearch.periodEndDate}
	            </if>
	            <if test="periodSearch.periodType.name() == 'CRE'">
	                AND nb.CREATE_DATE BETWEEN #{periodSearch.periodStartDate} AND #{periodSearch.periodEndDate}
	            </if>
	        </if>
	        <if test="keywordSearch != null">
	            <if test="keywordSearch.keywordType.name() == 'TITLE'">
	                AND nb.TITLE LIKE '%' || #{keywordSearch.keyword} || '%'
	            </if>
	            <if test="keywordSearch.keywordType.name() == 'CONTENTS'">
	                AND nb.CONTENTS LIKE '%' || #{keywordSearch.keyword} || '%'
	            </if>
	        </if>
	        <if test="displayFlag != null">
	            AND nb.DISPLAY_FLAG = #{displayFlag}
	        </if>
	        <if test="requestSource == 'APP'">
				AND (
					 nb.PUB_END_DATE IS NULL 
					 OR nb.PUB_ALWAYS_FLAG = 'Y' 
					 OR nb.PUB_END_DATE >= SYSDATE
				)
	        </if>
	</select>
    
    
    <insert id="insertNoticeDoc" parameterType="NoticeBoardDto">
    	INSERT INTO HPCMOBILE.HP_NOTICE_BOARD (
    		NOTICE_DOC_ID
    		, TITLE
    		, CONTENTS
    		, DISPLAY_FLAG
    		, ATTACH_FLAG
    		, PIN_FLAG
    		, HP_COMMON_CODE_ID
    		, PUB_ALWAYS_FLAG
    		, PUB_START_DATE
    		, PUB_END_DATE
    		, DELETE_FLAG
    		, CREATE_BY
    		, CREATE_DATE
    	) VALUES ( 
    		#{noticeDocId}
    		, #{title}
    		, #{contents, jdbcType=VARCHAR}
    		, #{displayFlag}
    		, #{attachFlag}
			, #{pinFlag}
        ,<choose>
            <when test="subCategoryId != null">
                #{subCategoryId}
            </when>
            <when test="parentCategoryId != null">
                #{parentCategoryId}
            </when>
            <otherwise>
                NULL
            </otherwise>
        </choose>
    		, #{pubAlwaysFlag}
    		, #{pubStartDate}
			, #{pubEndDate, jdbcType=DATE}
    		, 'N'
    		, #{createBy}
    		, SYSDATE
    	)
    </insert>
    
    <select id="selectNoticeDocDetail" resultType="NoticeBoardDto" parameterType="String">
    	SELECT 
			nb.NOTICE_DOC_ID 			AS noticeDocId
			, nb.TITLE					AS title
			, nb.CONTENTS 				AS contents
			, cdv.PARENT_CATE_ID 		AS parentCategoryId
			, cdv.PARENT_CATE_NAME 		AS parentCategoryName
			, cdv.SUB_CATE_ID 			AS subCategoryId
			, cdv.SUB_CATE_NAME 		AS subCategoryName
			, nb.ATTACH_FLAG			AS attachFlag
			, nb.DISPLAY_FLAG   		AS displayFlag
			, nb.PIN_FLAG				AS pinFlag
			, nb.PUB_ALWAYS_FLAG 		AS pubAlwaysFlag
			, nb.PUB_START_DATE 		AS pubStartDate
			, nb.PUB_END_DATE 			AS pubEndDate
			, nb.CREATE_DATE 			AS createDate
			, nb.CREATE_BY 				AS createBy
		FROM 
			HP_NOTICE_BOARD nb
		LEFT JOIN CATEGORY_DEPTH_VIEW cdv
				  ON nb.HP_COMMON_CODE_ID = cdv.SUB_CATE_ID
				  OR (
				    cdv.SUB_CATE_ID IS NULL
				    AND nb.HP_COMMON_CODE_ID = cdv.PARENT_CATE_ID
				    AND NOT EXISTS (
				        SELECT 1 FROM CATEGORY_DEPTH_VIEW sub_check
				        WHERE sub_check.SUB_CATE_ID = nb.HP_COMMON_CODE_ID
				    )
				  )
		WHERE 
			DELETE_FLAG = 'N'
			AND nb.NOTICE_DOC_ID = #{noticeDocId}    		
    </select>
        
    
    <update id="updateNoticeDoc" parameterType="NoticeBoardDto">
    	UPDATE 
  			HP_NOTICE_BOARD
  		SET
  			TITLE = #{title}
  			, CONTENTS = #{contents, jdbcType=VARCHAR}
  			, DISPLAY_FLAG = #{displayFlag}
  			, ATTACH_FLAG = #{attachFlag}
        <choose>
            <when test="subCategoryId != null">
                , HP_COMMON_CODE_ID = #{subCategoryId}
            </when>
            <when test="parentCategoryId != null">
                , HP_COMMON_CODE_ID = #{parentCategoryId}
            </when>
        </choose>  
  			, PIN_FLAG = #{pinFlag}
  			, PUB_ALWAYS_FLAG = #{pubAlwaysFlag}
  			, PUB_START_DATE = #{pubStartDate}
  			<if test="pubEndDate != null">
  				, PUB_END_DATE = #{pubEndDate}
  			</if>
  			, UPDATE_BY = #{updateBy}
    		, UPDATE_DATE = SYSDATE
    	WHERE
    		NOTICE_DOC_ID = #{noticeDocId}
    </update>
    
    
    <select id="selectAttachFileById" resultType="String">
    	SELECT 
			FILE_NAME AS fileName
		FROM 
			HP_ATTACH_FILE
		WHERE 
			ATTACH_ID IN 
			<foreach item="docId" collection="fileIds" open="(" separator="," close=")">
				#{docId}
	        </foreach>
    </select>
    
    <update id="deleteNoticeDoc" parameterType="String">
    	UPDATE 
  			HP_NOTICE_BOARD
  		SET
  			DELETE_FLAG = 'Y'
    		, UPDATE_DATE = SYSDATE
    	WHERE
    		NOTICE_DOC_ID = #{noticeDocId}
    </update>
    
    <update id="updateNoticeDocDisplayFlag" parameterType="NoticeBoardDto">
    	UPDATE
    		HP_NOTICE_BOARD
  		SET
  			DISPLAY_FLAG = #{displayFlag}	
  			, UPDATE_BY = #{updateBy}
    		, UPDATE_DATE = SYSDATE
    	WHERE
    		NOTICE_DOC_ID = #{noticeDocId}
    </update>
    
</mapper>
